name: Deploy Client to S3 and CloudFront

on:
  push:
    branches:
      - main
    paths:
      - "client/**"
      - ".github/workflows/deploy-client.yml"
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET: teacher-bo-client
  CLOUDFRONT_DISTRIBUTION_ID: E2HHRGQCO89EBY

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "20"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.RAG_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.RAG_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: |
          cd client
          echo "ðŸ“¦ Installing dependencies..."
          yarn install --frozen-lockfile
          echo "âœ… Dependencies installed"

      - name: Create .env file
        run: |
          cd client
          echo "${{ secrets.CLIENT_ENV }}" > .env
          echo "âœ… .env file created"

      - name: Export web build
        run: |
          cd client
          echo "ðŸ”¨ Exporting web build..."
          yarn export:web
          cp ./dist/canvaskit.wasm ./dist/_expo/static/js/web
          echo "âœ… Web build exported"
          ls -la dist/

      - name: Upload to S3
        run: |
          echo "ðŸ“¤ Uploading to S3 bucket: ${{ env.S3_BUCKET }}..."
          aws s3 sync client/dist/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # Upload HTML and JSON files with different cache settings
          aws s3 sync client/dist/ s3://${{ env.S3_BUCKET }}/ \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --cache-control "public, max-age=0, must-revalidate"

          echo "âœ… Upload to S3 completed"

      - name: Create CloudFront invalidation
        id: cloudfront
        run: |
          echo "ðŸ”„ Creating CloudFront invalidation..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*")
          echo "âœ… Invalidation created: ${INVALIDATION_ID}"

          echo "distribution_id=${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_OUTPUT
          echo "invalidation_id=${INVALIDATION_ID}" >> $GITHUB_OUTPUT

      - name: Wait for invalidation
        run: |
          echo "â³ Waiting for CloudFront invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
            --id ${{ steps.cloudfront.outputs.invalidation_id }}
          echo "âœ… Invalidation completed"

      - name: Get CloudFront domain
        id: domain
        run: |
          DOMAIN=$(aws cloudfront get-distribution \
            --id ${{ steps.cloudfront.outputs.distribution_id }} \
            --query "Distribution.DomainName" \
            --output text)

          echo "domain=${DOMAIN}" >> $GITHUB_OUTPUT

      - name: Deployment summary
        if: success()
        run: |
          echo "========================================="
          echo "ðŸŽ‰ Client Deployment Successful!"
          echo "========================================="
          echo "S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "CloudFront Distribution: ${{ steps.cloudfront.outputs.distribution_id }}"
          echo "Domain: https://${{ steps.domain.outputs.domain }}"
          echo "Invalidation: ${{ steps.invalidation.outputs.invalidation_id }}"
          echo "========================================="
